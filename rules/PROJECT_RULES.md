# Project Rules

## Naming & Aliases
- **Project**: 机会雷达 (Opportunity Radar / 机会雷达)
- **Module**: 策略雷达 (Strategy Radar / 策略雷达) - Core capability module.
- **Local dir**: `E:\OppRadar` (Historical alias / Reserved path).
- **Remote repo**: `OppOrder` (Opportunity Order / 机会订单) - Repository name.
- **Note**: Inconsistency between Repo Name and Project Name is ALLOWED but must be documented. Future external references use Opportunity Radar.

## Terminology
- **Strategy**: Trading logic definition.
- **Snapshot**: Point-in-time data capture.
- **Tag**: Label for filtering/grouping.
- **Status**: Lifecycle state (e.g., PENDING, DONE).

## Data Model v0.1
### Entity List
- **Strategy**: Defines the core trading logic and parameters.
- **Snapshot**: A frozen record of market data at a specific time.
- **Tag**: Metadata label for categorization (e.g., market condition, risk level).
- **Opportunity**: A detected potential trade setup linked to a Strategy and Snapshot.
- **Scan**: A record of an execution run that detects Opportunities.
- **Tradeable**: A derived status of an Opportunity indicating if it can be executed.

### Fields & Schema
#### Strategy
- `strategy_id`: String (Required). Format: `st_[a-z0-9]{8}`.
- `name`: String (Required). Human-readable name.
- `version`: String (Required). Semantic version (e.g., "1.0.0").
- `status`: String (Required). State machine: `DRAFT` -> `ACTIVE` -> `DEPRECATED`.
- `parameters`: Object (Optional). JSON object defining strategy-specific params.

#### Snapshot
- `snapshot_id`: String (Required). Format: `sn_[a-z0-9]{8}`.
- `strategy_id`: String (Required). Reference to Strategy.
- `timestamp`: String (Required). ISO8601 UTC.
- `data`: Object (Required). Market data payload (price, vol, indicators).

#### Tag
- `tag_id`: String (Required). Format: `tg_[a-z0-9]{8}`.
- `label`: String (Required). Display text.
- `color`: String (Optional). Hex code.

#### Opportunity
- `opp_id`: String (Required). Format: `op_[a-z0-9]{8}`.
- `strategy_id`: String (Required). Reference to Strategy.
- `snapshot_id`: String (Required). Reference to Snapshot.
- `score`: Number (Required). 0.0 to 1.0 confidence score.
- `created_at`: String (Required). ISO8601 UTC.
- `tradeable_state`: String (Derived). `YES` | `NO` | `UNKNOWN`.
- `tradeable_reason`: String (Derived). Explanation for the state.

#### Scan
- `scan_id`: String (Required). Format: `sc_[a-z0-9]{8}`.
- `timestamp`: String (Required). ISO8601 UTC.
- `opp_ids`: Array<String> (Required). List of detected `opp_id`s.
- `duration_ms`: Number (Required). Execution time.

### State Machines
- **Strategy Status**:
  - `DRAFT`: Initial creation, not ready for production.
  - `ACTIVE`: Approved for live/scanning usage.
  - `DEPRECATED`: No longer in use, kept for history.

- **Tradeable State** (Derived for Opportunity):
  - `YES`: Meets all criteria (score threshold, filters, risk checks).
  - `NO`: Failed one or more checks.
  - `UNKNOWN`: Insufficient data to determine.

## Gate Light / Evidence Terminology
- **Gate Light**: The automated CI check (gate-light) that validates the latest Evidence Envelope.
- **Evidence Envelope**: The complete set of artifacts (Result JSON + Notify + Logs + Index) generated by envelope_build.mjs.
- **LATEST.json**: A pointer file in rules/ that tracks the most recently generated task evidence location. CI uses this to know what to validate.

## M2 Interfaces (Diff & Replay)
### Diff API (v0)
- **Endpoint**: `GET /diff`
- **Port**: 53122
- **Parameters**:
  - `from_scan`: String (Required). Source scan ID.
  - `to_scan`: String (Required). Target scan ID.
- **Response** (200 OK):
  - `from_scan_id`: String.
  - `to_scan_id`: String.
  - `added_opp_ids`: Array<String>. IDs present in `to` but not `from`.
  - `removed_opp_ids`: Array<String>. IDs present in `from` but not `to`.
  - `changed`: Array<Object>.
    - `opp_id`: String.
    - `diff`: Object (Key: {from, to}).
- **Errors**:
  - `400`: Missing `from_scan` or `to_scan`.
  - `404`: Scan ID not found in fixtures.
  - `500`: Internal read error.

### Replay API (v0)
- **Endpoint**: `GET /replay`
- **Port**: 53122
- **Parameters**:
  - `scan`: String (Required). Target scan ID.
- **Response** (200 OK):
  - `scan`: Object. Full scan record (scan_id, timestamp, opp_ids, duration_ms).
  - `opportunities`: Array<Object>. Expanded opportunity details in order of `opp_ids`.
  - `missing_opp_ids`: Array<String>. IDs listed in scan but missing from opportunities fixture.
- **Errors**:
  - `400`: Missing `scan`.
  - `404`: Scan ID not found.
  - `500`: Internal read error.

### UI Specs
- **Paths**:
  - `/ui/diff`:
    - Select `from` and `to` scans (sorted by time desc).
    - Display Added/Removed counts and lists.
    - Display Changed fields (from -> to).
    - Links to `/ui/opportunities/<opp_id>`.
  - `/ui/replay`:
    - Select `scan` (sorted by time desc).
    - Button "Replay" -> `/ui/replay/<scan_id>`.
  - `/ui/replay/<scan_id>`:
    - Display Scan metadata (Time, Duration, Count).
    - List all Opportunities (ID, Strategy, Score, State, Reason).
    - **Export JSON**: Button/Link opening `/replay?scan=<scan_id>` in new tab.

## Operational Standards
- **Command & Environment**:
  - **Default Shell**: PowerShell.
  - **Constraint**: If Trae identifies the shell as non-CMD (e.g., PowerShell, bash), **`cd /d` is STRICTLY PROHIBITED**. Use `cd 'Path'` or `Set-Location`.
  - See `rules/WORKFLOW.md` for standard templates.
- **Interactive Prompts**: Strictly forbidden.
- **CI Path Consistency**: When generating evidence in the `OppRadar` subdirectory (workaround), MUST ensure `LATEST.json` and `result_*.json` paths are relative to Repo Root (e.g., `rules/...` NOT `OppRadar/rules/...`). Manually sanitize if necessary.
- **Task ID Uniqueness**:
  - **Rule**: A single `task_id` can ONLY correspond to ONE merged evidence pack in `main`.
  - **Constraint**: Once a `task_id` is merged to `main`, it is immutable. Any fixes or rework MUST use a NEW `task_id`.
  - **Exception**: If following a specific workflow exception (e.g., "Patch Task"), follow that protocol, but generally prefer new IDs to avoid noise.
