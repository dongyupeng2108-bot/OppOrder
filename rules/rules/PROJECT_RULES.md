# Project Rules

## Naming & Aliases
- **Project**: 机会雷达 (Opportunity Radar / 机会雷达)
- **Module**: 策略雷达 (Strategy Radar / 策略雷达) - Core capability module.
- **Local dir**: `E:\OppRadar` (Historical alias / Reserved path).
- **Remote repo**: `OppOrder` (Opportunity Order / 机会订单) - Repository name.
- **Note**: Inconsistency between Repo Name and Project Name is ALLOWED but must be documented. Future external references use Opportunity Radar.

## Terminology
- **Strategy**: Trading logic definition.
- **Snapshot**: Point-in-time data capture.
- **Tag**: Label for filtering/grouping.
- **Status**: Lifecycle state (e.g., PENDING, DONE).

## Data Model v0.1
### Entity List
- **Strategy**: Defines the core trading logic and parameters.
- **Snapshot**: A frozen record of market data at a specific time.
- **Tag**: Metadata label for categorization (e.g., market condition, risk level).
- **Opportunity**: A detected potential trade setup linked to a Strategy and Snapshot.
- **Scan**: A record of an execution run that detects Opportunities.
- **Tradeable**: A derived status of an Opportunity indicating if it can be executed.

### Fields & Schema
#### Strategy
- `strategy_id`: String (Required). Format: `st_[a-z0-9]{8}`.
- `name`: String (Required). Human-readable name.
- `version`: String (Required). Semantic version (e.g., "1.0.0").
- `status`: String (Required). State machine: `DRAFT` -> `ACTIVE` -> `DEPRECATED`.
- `parameters`: Object (Optional). JSON object defining strategy-specific params.

#### Snapshot
- `snapshot_id`: String (Required). Format: `sn_[a-z0-9]{8}`.
- `strategy_id`: String (Required). Reference to Strategy.
- `timestamp`: String (Required). ISO8601 UTC.
- `data`: Object (Required). Market data payload (price, vol, indicators).

#### Tag
- `tag_id`: String (Required). Format: `tg_[a-z0-9]{8}`.
- `label`: String (Required). Display text.
- `color`: String (Optional). Hex code.

#### Opportunity
- `opp_id`: String (Required). Format: `op_[a-z0-9]{8}`.
- `strategy_id`: String (Required). Reference to Strategy.
- `snapshot_id`: String (Required). Reference to Snapshot.
- `score`: Number (Required). 0.0 to 1.0 confidence score.
- `created_at`: String (Required). ISO8601 UTC.
- `tradeable_state`: String (Derived). `YES` | `NO` | `UNKNOWN`.
- `tradeable_reason`: String (Derived). Explanation for the state.

#### Scan
- `scan_id`: String (Required). Format: `sc_[a-z0-9]{8}`.
- `timestamp`: String (Required). ISO8601 UTC.
- `opp_ids`: Array<String> (Required). List of detected `opp_id`s.
- `duration_ms`: Number (Required). Execution time.

### State Machines
- **Strategy Status**:
  - `DRAFT`: Initial creation, not ready for production.
  - `ACTIVE`: Approved for live/scanning usage.
  - `DEPRECATED`: No longer in use, kept for history.

- **Tradeable State** (Derived for Opportunity):
  - `YES`: Meets all criteria (score threshold, filters, risk checks).
  - `NO`: Failed one or more checks.
  - `UNKNOWN`: Insufficient data to determine.

## Gate Light / Evidence Terminology
- **Gate Light**: The automated CI check (gate-light) that validates the latest Evidence Envelope.
- **Evidence Envelope**: The complete set of artifacts (Result JSON + Notify + Logs + Index) generated by envelope_build.mjs.
- **LATEST.json**: A pointer file in rules/ that tracks the most recently generated task evidence location. CI uses this to know what to validate.

## Gate Light Hardening Rules
- **Immutable Integrate**: Once a task passes Integrate, it is LOCKED via `rules/task-reports/locks/<task_id>.lock.json`. Reruns are blocked (Exit 33). Any new changes require a NEW `task_id`.
- **SafeCmd**: Chained shell commands (`;`, `&&`, `||`) are prohibited in `command_audit` logs to prevent high-risk execution bypass. Use `scripts/safe_commit.ps1` or `scripts/safe_push.ps1` instead.
- **CI Parity Evidence-as-Code**: Task evidence MUST include `ci_parity_<task_id>.json`. Gate Light performs mandatory re-calculation and anti-cheat validation (e.g., prohibiting `head != base` with 0 files).
- **Clean-State Integration**: The Integrate phase (`dev_batch_mode -Mode Integrate`) strictly enforces a clean git working directory. Uncommitted changes to code files (anything other than `rules/task-reports/**`, `rules/rules/**`, `rules/LATEST.json`) will trigger a hard block (`exit 31`).
- **Deletion Audit**: locks/runs is append-only; deletion is forbidden; Gate Light will fail if missing. All tasks (>= 260211_006) must be indexed in `rules/task-reports/index/runs_index.jsonl`.
- **No Auto-Merge**: The Agent MUST NOT execute `git merge` or `git push ... main` (or to any protected branch). Only the Human User (Owner) can perform the merge. The Agent's job ends at "PR Created + Gate Light PASS". Violation (detected by Gate Light in `command_audit`) triggers immediate failure (Exit 62).

## M2 Interfaces (Diff & Replay)
### Diff API (v0)
- **Endpoint**: `GET /diff`
- **Port**: 53122
- **Parameters**:
  - `from_scan`: String (Required). Source scan ID.
  - `to_scan`: String (Required). Target scan ID.
- **Response** (200 OK):
  - `from_scan_id`: String.
  - `to_scan_id`: String.
  - `added_opp_ids`: Array<String>. IDs present in `to` but not `from`.
  - `removed_opp_ids`: Array<String>. IDs present in `from` but not `to`.
  - `changed`: Array<Object>.
    - `opp_id`: String.
    - `diff`: Object (Key: {from, to}).
- **Errors**:
  - `400`: Missing `from_scan` or `to_scan`.
  - `404`: Scan ID not found in fixtures.
  - `500`: Internal read error.

### Replay API (v0)
- **Endpoint**: `GET /replay`
- **Port**: 53122
- **Parameters**:
  - `scan`: String (Required). Target scan ID.
- **Response** (200 OK):
  - `scan_id`: String.
  - `replay_events`: Array<Object>. Replayable events (e.g. snapshots).

### Pipeline v1 APIs (M4)
#### Runs List API
- **Endpoint**: `GET /opportunities/runs`
- **Parameters**: `limit` (max 50, default 20)
- **Response**: Array of `{ run_id, ts, jobs_ok, jobs_failed, meta_json }`

#### Opportunities By Run API
- **Endpoint**: `GET /opportunities/by_run`
- **Parameters**: `run_id` (Required), `limit` (max 50, default 20)
- **Response**: Array of Opportunity Objects (sorted by score desc)

## DoD Markers (Gate Light)
- **DOD_EVIDENCE_OPPS_RUNS_LIST**: `<path> => contains_run_id=true count=...`
- **DOD_EVIDENCE_OPPS_BY_RUN**: `<path> => rows=... all_same_run_id=true`
  - Returns array of scan objects or similar replay data.

## API Contracts (v1.0)
### News Pull API (`POST /news/pull`)
- **Schema**: `OppRadar/contracts/news_pull_response.schema.json`
- **Success Response (200 OK)**:
  - `status`: "ok"
  - `provider_used`: "local" | "gdelt"
  - `fallback`: Boolean (true if fallback occurred)
  - `cached`: Boolean (true if result from cache)
  - `cache_key`: String (SHA-256) or null
  - `inserted_count`: Number (Written to DB)
  - `deduped_count`: Number (Skipped due to duplicate)
  - `fetched_count`: Number (Total items from provider)
  - `written_count`: Number (Same as inserted_count)
  - `request`: Object (Echo of normalized inputs)
    - `provider`, `topic_key`, `query`, `timespan`, `maxrecords`
- **Error Response (400 Bad Request)**:
  - `status`: "error"
  - `code`: "MAXRECORDS_LIMIT" (if maxrecords > 50)
  - `message`: String
  - `request`: Object (Echo of inputs)

### LLM Route API (`POST /opportunities/llm_route`)
- **Schema**: `OppRadar/contracts/llm_route_response.schema.json`
- **Parameters** (JSON Body):
  - `run_id`: String (Required).
  - `limit`: Number (Optional, max 50).
  - `provider`: String (Optional, "mock"|"deepseek").
  - `model`: String (Optional).
- **Success Response (200 OK)**:
  - `status`: "ok"
  - `run_id`: String
  - `provider_used`: "mock" | "deepseek"
  - `model_used`: String
  - `items`: Array<Object>
    - `opp_id`: String
    - `llm_json`: Object (Structured output)
- **Error Response (400 Bad Request)**:
  - `status`: "error"
  - `code`: String
  - `message`: String

### Scan Run API (`POST /scans/run`)
- **Schema**: N/A (Internal v0)
- **Parameters** (JSON Body):
  - `n_opps`: Number (Optional, default 5).
  - `mode`: String (Optional, default 'random').
  - `smoke_run_id`: String (Optional).
- **Success Response (200 OK)**:
  - `scan_id`: String.
  - `opp_ids`: Array<String>.
  - `opportunities`: Array<Object>.
  - `cached`: Boolean.
  - `cache_key`: String (SHA-256).
  - `cached_from_scan_id`: String (If cached=true).

## DoD Evidence Standards
### Scan Cache Markers
- **Required for Task ID >= 260209_002**
- **File**: `notify_<task_id>.txt` and `result_<task_id>.json` (dod_evidence.scan_cache)
- **Format**:
  - MISS: `DOD_EVIDENCE_SCAN_CACHE_MISS: <path> => cached=false duration_ms=<n>`
  - HIT:  `DOD_EVIDENCE_SCAN_CACHE_HIT:  <path> => cached=true  duration_ms=<n>`

### DoD Stdout Mechanism
- **Required for Task ID >= 260209_003**
- **Reporting**: Reports MUST paste the `=== DOD_EVIDENCE_STDOUT ===` block (automatically printed by Integrate phase) directly into the PR/Report.
- **Artifacts**:
  - `dod_stdout_<task_id>.txt` must exist in `rules/task-reports/YYYY-MM/`.
  - `notify_<task_id>.txt` must contain the same block.
  - All `DOD_EVIDENCE_` lines must contain `=>` followed by the excerpt.

## Gate Light Hardening Rules (Task 260209_009)
### CI 校验对象锁定与 LATEST 一致性 (PR Task Lock + LATEST Consistency)
*   **Single Source of Truth**: 以 CI Checks (GitHub Actions) 结果为准。本地 Pass 仅作为参考，必须通过 CI 门禁才能合并。
*   **PR Task Lock**: PR 门禁必须校验“本 PR 的 `task_id`”（从分支名或 PR diff 解析），不得仅依赖 `rules/LATEST.json`。
*   **LATEST Consistency**: 不得跳过 `rules/LATEST.json`。当 PR 解析出 `pr_task_id` 时，`rules/LATEST.json.task_id` 必须等于 `pr_task_id`，否则门禁 FAIL（`LATEST_OUT_OF_SYNC=1`）。
*   **Environment Alignment**: 本地 Integrate（集成）与 CI（持续集成）必须对齐：两者运行 `gate_light_ci.mjs` 时要校验同一个 `task_id`（本地通过 `--task_id` 显式传参，CI 通过 PR 自动锁定或显式传参）。
*   **CI Parity Probe**: 必须生成 `=== CI_PARITY_PREVIEW ===` 证据，显式展示 Git Context (Origin/Main, HEAD, MergeBase) 和 Task Detection Source。
*   **Ambiguity Fail-fast**: 若 PR 无法解析唯一 `task_id`（0 个或多个候选），必须 FAIL-fast 并输出固定提示块 `PR_TASK_ID_DETECT_FAILED=1`，要求修正分支命名或证据变更范围。

### NoHistoricalEvidenceTouch
- **Rule**: Modifications to `rules/task-reports/**` files that do NOT contain the current `task_id` in their filename are strictly PROHIBITED.
- **Goal**: Prevent accidental modification of historical evidence or cross-talk between tasks.
- **Failure Example**: Modifying `rules/task-reports/2026-02/opps_pipeline_smoke_260209_008.txt` while working on task `260209_009`.
- **Fix**: Revert the file using `git restore --source=origin/main -- <path>`. If the data is new, save it to a new file containing the current `task_id`.

### SnippetCommitMustMatch
- **Rule**: The `COMMIT:` field in `trae_report_snippet_<task_id>.txt` must match `git rev-parse --short HEAD`.
- **Goal**: Prevent "Snippet Drift" where evidence is generated on commit A, but the code is amended to commit B without regenerating evidence.
- **Exception**: Mismatch is ALLOWED if the diff between Snippet COMMIT and HEAD contains ONLY changes to `rules/task-reports/**` (Evidence), `rules/rules/**` (Docs), or `rules/LATEST.json`.
- **Failure Example**: `Snippet COMMIT (abc1234) does not match HEAD (def5678)` with code changes.
- **Fix**: Re-run the Integrate phase (or just the snippet builder) to regenerate the snippet with the current HEAD.

## Immutable Integrate & SafeCmd (Task 260211_003)
*   **Immutable Integrate (One-shot)**:
    *   **Lock**: The Integrate phase creates `rules/task-reports/locks/<task_id>.lock.json` on success.
    *   **Rerun Block**: Subsequent runs for the same `task_id` are BLOCKED (`EXIT=33`) if the lock exists.
    *   **Archive**: Evidence is archived to `rules/task-reports/runs/<task_id>/<run_id>/` (append-only) for audit.
*   **SafeCmd Mechanism**:
    *   **Prohibited**: Chained commands (`;`, `&&`, `||`) in `TraeTask` commands.
    *   **Enforcement**: Gate Light scans evidence (`trae_report_snippet`, `dod_stdout`, `command_audit`) and fails if chains are detected.
    *   **Recommended**: Use `scripts/safe_commit.ps1` and `scripts/safe_push.ps1`.
