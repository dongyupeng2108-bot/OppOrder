# Project Rules

## Naming & Aliases
- **Project**: 机会雷达 (Opportunity Radar / 机会雷达)
- **Module**: 策略雷达 (Strategy Radar / 策略雷达) - Core capability module.
- **Local dir**: `E:\OppRadar` (Historical alias / Reserved path).
- **Remote repo**: `OppOrder` (Opportunity Order / 机会订单) - Repository name.
- **Note**: Inconsistency between Repo Name and Project Name is ALLOWED but must be documented. Future external references use Opportunity Radar.

## Terminology
- **Strategy**: Trading logic definition.
- **Snapshot**: Point-in-time data capture.
- **Tag**: Label for filtering/grouping.
- **Status**: Lifecycle state (e.g., PENDING, DONE).

## Data Model v0.1
### Entity List
- **Strategy**: Defines the core trading logic and parameters.
- **Snapshot**: A frozen record of market data at a specific time.
- **Tag**: Metadata label for categorization (e.g., market condition, risk level).
- **Opportunity**: A detected potential trade setup linked to a Strategy and Snapshot.
- **Scan**: A record of an execution run that detects Opportunities.
- **Tradeable**: A derived status of an Opportunity indicating if it can be executed.

### Fields & Schema
#### Strategy
- `strategy_id`: String (Required). Format: `st_[a-z0-9]{8}`.
- `name`: String (Required). Human-readable name.
- `version`: String (Required). Semantic version (e.g., "1.0.0").
- `status`: String (Required). State machine: `DRAFT` -> `ACTIVE` -> `DEPRECATED`.
- `parameters`: Object (Optional). JSON object defining strategy-specific params.

#### Snapshot
- `snapshot_id`: String (Required). Format: `sn_[a-z0-9]{8}`.
- `strategy_id`: String (Required). Reference to Strategy.
- `timestamp`: String (Required). ISO8601 UTC.
- `data`: Object (Required). Market data payload (price, vol, indicators).

#### Tag
- `tag_id`: String (Required). Format: `tg_[a-z0-9]{8}`.
- `label`: String (Required). Display text.
- `color`: String (Optional). Hex code.

#### Opportunity
- `opp_id`: String (Required). Format: `op_[a-z0-9]{8}`.
- `strategy_id`: String (Required). Reference to Strategy.
- `snapshot_id`: String (Required). Reference to Snapshot.
- `score`: Number (Required). 0.0 to 1.0 confidence score.
- `created_at`: String (Required). ISO8601 UTC.
- `tradeable_state`: String (Derived). `YES` | `NO` | `UNKNOWN`.
- `tradeable_reason`: String (Derived). Explanation for the state.

#### Scan
- `scan_id`: String (Required). Format: `sc_[a-z0-9]{8}`.
- `timestamp`: String (Required). ISO8601 UTC.
- `opp_ids`: Array<String> (Required). List of detected `opp_id`s.
- `duration_ms`: Number (Required). Execution time.

### State Machines
- **Strategy Status**:
  - `DRAFT`: Initial creation, not ready for production.
  - `ACTIVE`: Approved for live/scanning usage.
  - `DEPRECATED`: No longer in use, kept for history.

- **Tradeable State** (Derived for Opportunity):
  - `YES`: Meets all criteria (score threshold, filters, risk checks).
  - `NO`: Failed one or more checks.
  - `UNKNOWN`: Insufficient data to determine.

## Gate Light / Evidence Terminology
- **Gate Light**: The automated CI check (gate-light) that validates the latest Evidence Envelope.
- **Evidence Envelope**: The complete set of artifacts (Result JSON + Notify + Logs + Index) generated by envelope_build.mjs.
- **LATEST.json**: A pointer file in rules/ that tracks the most recently generated task evidence location. CI uses this to know what to validate.

## M2 Interfaces (Diff & Replay)
### Diff API (v0)
- **Endpoint**: `GET /diff`
- **Port**: 53122
- **Parameters**:
  - `from_scan`: String (Required). Source scan ID.
  - `to_scan`: String (Required). Target scan ID.
- **Response** (200 OK):
  - `from_scan_id`: String.
  - `to_scan_id`: String.
  - `added_opp_ids`: Array<String>. IDs present in `to` but not `from`.
  - `removed_opp_ids`: Array<String>. IDs present in `from` but not `to`.
  - `changed`: Array<Object>.
    - `opp_id`: String.
    - `diff`: Object (Key: {from, to}).
- **Errors**:
  - `400`: Missing `from_scan` or `to_scan`.
  - `404`: Scan ID not found in fixtures.
  - `500`: Internal read error.

### Replay API (v0)
- **Endpoint**: `GET /replay`
- **Port**: 53122
- **Parameters**:
  - `scan`: String (Required). Target scan ID.
- **Response** (200 OK):
  - Returns array of scan objects or similar replay data.

## API Contracts (v1.0)
### News Pull API (`POST /news/pull`)
- **Schema**: `OppRadar/contracts/news_pull_response.schema.json`
- **Success Response (200 OK)**:
  - `status`: "ok"
  - `provider_used`: "local" | "gdelt"
  - `fallback`: Boolean (true if fallback occurred)
  - `cached`: Boolean (true if result from cache)
  - `cache_key`: String (SHA-256) or null
  - `inserted_count`: Number (Written to DB)
  - `deduped_count`: Number (Skipped due to duplicate)
  - `fetched_count`: Number (Total items from provider)
  - `written_count`: Number (Same as inserted_count)
  - `request`: Object (Echo of normalized inputs)
    - `provider`, `topic_key`, `query`, `timespan`, `maxrecords`
- **Error Response (400 Bad Request)**:
  - `status`: "error"
  - `code`: "MAXRECORDS_LIMIT" (if maxrecords > 50)
  - `message`: String
  - `request`: Object (Echo of inputs)

### Scan Run API (`POST /scans/run`)
- **Schema**: N/A (Internal v0)
- **Parameters** (JSON Body):
  - `n_opps`: Number (Optional, default 5).
  - `mode`: String (Optional, default 'random').
  - `smoke_run_id`: String (Optional).
- **Success Response (200 OK)**:
  - `scan_id`: String.
  - `opp_ids`: Array<String>.
  - `opportunities`: Array<Object>.
  - `cached`: Boolean.
  - `cache_key`: String (SHA-256).
  - `cached_from_scan_id`: String (If cached=true).

## DoD Evidence Standards
### Scan Cache Markers
- **Required for Task ID >= 260209_002**
- **File**: `notify_<task_id>.txt` and `result_<task_id>.json` (dod_evidence.scan_cache)
- **Format**:
  - MISS: `DOD_EVIDENCE_SCAN_CACHE_MISS: <path> => cached=false duration_ms=<n>`
  - HIT:  `DOD_EVIDENCE_SCAN_CACHE_HIT:  <path> => cached=true  duration_ms=<n>`

### DoD Stdout Mechanism
- **Required for Task ID >= 260209_003**
- **Reporting**: Reports MUST paste the `=== DOD_EVIDENCE_STDOUT ===` block (automatically printed by Integrate phase) directly into the PR/Report.
- **Artifacts**:
  - `dod_stdout_<task_id>.txt` must exist in `rules/task-reports/YYYY-MM/`.
  - `notify_<task_id>.txt` must contain the same block.
  - All `DOD_EVIDENCE_` lines must contain `=>` followed by the excerpt.
